<mxfile host="65bd71144e">
    <diagram name="Custom Instruction Matching" id="0">
        <mxGraphModel dx="1086" dy="655" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1400" pageHeight="950" math="0" shadow="0">
            <root>
                <mxCell id="0"/>
                <mxCell id="1" parent="0"/>
                <mxCell id="title" value="复杂指令匹配：根节点 + Pattern Tree" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;fontSize=18;fontStyle=1;" parent="1" vertex="1">
                    <mxGeometry x="345" y="20" width="400" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="mlir_title" value="1. MLIR Pattern&amp;nbsp;" style="text;html=1;strokeColor=none;fillColor=#d5e8d4;align=left;verticalAlign=top;fontSize=14;fontStyle=1;" parent="1" vertex="1">
                    <mxGeometry x="50" y="70" width="380" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="mlir_code" value="func @pattern(%arg0, %arg1: index) -&amp;gt; index {&lt;br&gt;  &lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;%result = scf.if %cond -&amp;gt; index {&lt;br&gt;    &lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;%v1 = arith.muli %arg0, %c2 : index&lt;br&gt;    &lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;memref.store %v1, %mem[%c0] : memref&amp;lt;4xindex&amp;gt;&lt;br&gt;    &lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;scf.yield %v1 : index&lt;br&gt;  &lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;} else {&lt;br&gt;    &lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;%v2 = arith.addi %arg0, %arg1 : index&lt;br&gt;    &lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;scf.yield %v2 : index&lt;br&gt;  &lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;}&lt;br&gt;  &lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;return %result&lt;br&gt;}" style="text;html=1;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;fontFamily=Courier New;fontSize=11;" parent="1" vertex="1">
                    <mxGeometry x="50" y="100" width="430" height="180" as="geometry"/>
                </mxCell>
                <mxCell id="skeleton_title" value="2. Skeleton (控制流框架 + Vec[Root])" style="text;html=1;strokeColor=none;fillColor=#fff2cc;align=left;verticalAlign=top;fontSize=14;fontStyle=1;" parent="1" vertex="1">
                    <mxGeometry x="520" y="70" width="400" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="skeleton_cf" value="SkeletonNode(scf.if)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=12;fontStyle=1;" parent="1" vertex="1">
                    <mxGeometry x="600" y="110" width="260" height="40" as="geometry"/>
                </mxCell>
                <mxCell id="then_block" value="SkeletonBlock(&quot;then&quot;)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=11;fontStyle=1;" parent="1" vertex="1">
                    <mxGeometry x="530" y="170" width="180" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="then_vec" value="Vec[Root] (副作用操作)" style="text;html=1;align=center;fontSize=10;fontStyle=2;fontColor=#d6b656;" parent="1" vertex="1">
                    <mxGeometry x="530" y="200" width="180" height="20" as="geometry"/>
                </mxCell>
                <mxCell id="then_root0" value="then_root 0: store %v1" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=10;fontStyle=1;" parent="1" vertex="1">
                    <mxGeometry x="530" y="220" width="180" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="then_root1" value="then_root 1: yield %v1" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=10;fontStyle=1;" parent="1" vertex="1">
                    <mxGeometry x="530" y="255" width="180" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="else_block" value="SkeletonBlock(&quot;else&quot;)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=11;fontStyle=1;" parent="1" vertex="1">
                    <mxGeometry x="750" y="170" width="180" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="else_vec" value="Vec[Root] (副作用操作)" style="text;html=1;align=center;fontSize=10;fontStyle=2;fontColor=#d6b656;" parent="1" vertex="1">
                    <mxGeometry x="750" y="200" width="180" height="20" as="geometry"/>
                </mxCell>
                <mxCell id="else_root0" value="else_root 0: yield %v2" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=10;fontStyle=1;" parent="1" vertex="1">
                    <mxGeometry x="750" y="220" width="180" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="edge1" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" parent="1" source="skeleton_cf" target="then_block" edge="1">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="edge2" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" parent="1" source="skeleton_cf" target="else_block" edge="1">
                    <mxGeometry relative="1" as="geometry">
                        <Array as="points">
                            <mxPoint x="730" y="170"/>
                        </Array>
                    </mxGeometry>
                </mxCell>
                <mxCell id="pattern_title" value="3. 根节点形成Pattern Tree (components)" style="text;html=1;strokeColor=none;fillColor=#f8cecc;align=left;verticalAlign=top;fontSize=14;fontStyle=1;" parent="1" vertex="1">
                    <mxGeometry x="50" y="310" width="400" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="tree0_title" value="then_root 0: store %v1" style="text;html=1;align=center;fontSize=11;fontStyle=1;" parent="1" vertex="1">
                    <mxGeometry x="60" y="350" width="180" height="20" as="geometry"/>
                </mxCell>
                <mxCell id="tree0_root" value="Term.store" style="ellipse;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=10;fontStyle=1;" parent="1" vertex="1">
                    <mxGeometry x="90" y="380" width="120" height="40" as="geometry"/>
                </mxCell>
                <mxCell id="tree0_child" value="Term.muli" style="ellipse;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontSize=10;" parent="1" vertex="1">
                    <mxGeometry x="90" y="440" width="120" height="40" as="geometry"/>
                </mxCell>
                <mxCell id="tree0_left" value="arg0" style="ellipse;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=9;" parent="1" vertex="1">
                    <mxGeometry x="40" y="500" width="60" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="tree0_right" value="c2" style="ellipse;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=9;" parent="1" vertex="1">
                    <mxGeometry x="120" y="500" width="60" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="tree0_edge1" style="edgeStyle=none;html=1;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" parent="1" source="tree0_root" target="tree0_child" edge="1">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="tree0_edge2" style="edgeStyle=none;html=1;exitX=0.3;exitY=1;entryX=0.5;entryY=0;" parent="1" source="tree0_child" target="tree0_left" edge="1">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="tree0_edge3" style="edgeStyle=none;html=1;exitX=0.7;exitY=1;entryX=0.5;entryY=0;" parent="1" source="tree0_child" target="tree0_right" edge="1">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="tree1_title" value="&lt;span style=&quot;color: rgb(0, 0, 0);&quot;&gt;then_root 1&lt;/span&gt;: yield %v1" style="text;html=1;align=center;fontSize=11;fontStyle=1;" parent="1" vertex="1">
                    <mxGeometry x="270" y="350" width="180" height="20" as="geometry"/>
                </mxCell>
                <mxCell id="tree1_root" value="Term.yield_" style="ellipse;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=10;fontStyle=1;" parent="1" vertex="1">
                    <mxGeometry x="300" y="380" width="120" height="40" as="geometry"/>
                </mxCell>
                <mxCell id="tree1_child" value="Term.muli" style="ellipse;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontSize=10;" parent="1" vertex="1">
                    <mxGeometry x="300" y="440" width="120" height="40" as="geometry"/>
                </mxCell>
                <mxCell id="tree1_left" value="arg0" style="ellipse;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=9;" parent="1" vertex="1">
                    <mxGeometry x="250" y="500" width="60" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="tree1_right" value="c2" style="ellipse;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=9;" parent="1" vertex="1">
                    <mxGeometry x="330" y="500" width="60" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="tree1_edge1" style="edgeStyle=none;html=1;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" parent="1" source="tree1_root" target="tree1_child" edge="1">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="tree1_edge2" style="edgeStyle=none;html=1;exitX=0.3;exitY=1;entryX=0.5;entryY=0;" parent="1" source="tree1_child" target="tree1_left" edge="1">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="tree1_edge3" style="edgeStyle=none;html=1;exitX=0.7;exitY=1;entryX=0.5;entryY=0;" parent="1" source="tree1_child" target="tree1_right" edge="1">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="tree2_title" value="else_root 0: yield %v2" style="text;html=1;align=center;fontSize=11;fontStyle=1;" parent="1" vertex="1">
                    <mxGeometry x="480" y="350" width="180" height="20" as="geometry"/>
                </mxCell>
                <mxCell id="tree2_root" value="Term.yield_" style="ellipse;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=10;fontStyle=1;" parent="1" vertex="1">
                    <mxGeometry x="510" y="380" width="120" height="40" as="geometry"/>
                </mxCell>
                <mxCell id="tree2_child" value="Term.addi" style="ellipse;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontSize=10;" parent="1" vertex="1">
                    <mxGeometry x="510" y="440" width="120" height="40" as="geometry"/>
                </mxCell>
                <mxCell id="tree2_left" value="arg0" style="ellipse;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=9;" parent="1" vertex="1">
                    <mxGeometry x="460" y="500" width="60" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="tree2_right" value="arg1" style="ellipse;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=9;" parent="1" vertex="1">
                    <mxGeometry x="540" y="500" width="60" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="tree2_edge1" style="edgeStyle=none;html=1;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" parent="1" source="tree2_root" target="tree2_child" edge="1">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="tree2_edge2" style="edgeStyle=none;html=1;exitX=0.3;exitY=1;entryX=0.5;entryY=0;" parent="1" source="tree2_child" target="tree2_left" edge="1">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="tree2_edge3" style="edgeStyle=none;html=1;exitX=0.7;exitY=1;entryX=0.5;entryY=0;" parent="1" source="tree2_child" target="tree2_right" edge="1">
                    <mxGeometry relative="1" as="geometry"/>
                </mxCell>
                <mxCell id="match_title" value="4. 两阶段匹配流程" style="text;html=1;strokeColor=none;fillColor=#d5e8d4;align=left;verticalAlign=top;fontSize=14;fontStyle=1;" parent="1" vertex="1">
                    <mxGeometry x="700" y="310" width="300" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="phase1_title" value="阶段1: egglog匹配component" style="text;html=1;align=left;fontSize=11;fontStyle=1;fontColor=#6c8ebf;" parent="1" vertex="1">
                    <mxGeometry x="700" y="345" width="280" height="20" as="geometry"/>
                </mxCell>
                <mxCell id="step1" value="① 扁平化pattern tree生成rewrites" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=11;align=left;" parent="1" vertex="1">
                    <mxGeometry x="700" y="368" width="280" height="28" as="geometry"/>
                </mxCell>
                <mxCell id="step2" value="② egglog高效匹配所有component" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=11;align=left;" parent="1" vertex="1">
                    <mxGeometry x="700" y="400" width="280" height="28" as="geometry"/>
                </mxCell>
                <mxCell id="phase2_title" value="阶段2: MeggEGraph检索控制流" style="text;html=1;align=left;fontSize=11;fontStyle=1;fontColor=#b85450;" parent="1" vertex="1">
                    <mxGeometry x="700" y="438" width="280" height="20" as="geometry"/>
                </mxCell>
                <mxCell id="step3" value="③ 序列化到MeggEGraph (本地)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=11;align=left;" parent="1" vertex="1">
                    <mxGeometry x="700" y="461" width="280" height="28" as="geometry"/>
                </mxCell>
                <mxCell id="step4" value="④ cf_index查找控制流 + Vec[Root]" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=11;align=left;" parent="1" vertex="1">
                    <mxGeometry x="700" y="493" width="280" height="28" as="geometry"/>
                </mxCell>
                <mxCell id="step5" value="⑤ 验证: 顺序 + operand_constraints" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=11;align=left;" parent="1" vertex="1">
                    <mxGeometry x="700" y="525" width="280" height="28" as="geometry"/>
                </mxCell>
                <mxCell id="step6" value="⑥ 添加custom_instr到E-graph" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=11;align=left;fontStyle=1;" parent="1" vertex="1">
                    <mxGeometry x="700" y="557" width="280" height="28" as="geometry"/>
                </mxCell>
                <mxCell id="key_title" value="核心要点" style="text;html=1;strokeColor=none;fillColor=#f5f5f5;align=center;verticalAlign=top;fontSize=14;fontStyle=1;" parent="1" vertex="1">
                    <mxGeometry x="50" y="610" width="930" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="key1" value="• Vec[Root]: 只存储根节点 (副作用操作: yield/store/load, 控制流节点)" style="text;html=1;align=left;fontSize=11;fontStyle=1;fontColor=#d6b656;" parent="1" vertex="1">
                    <mxGeometry x="60" y="645" width="450" height="25" as="geometry"/>
                </mxCell>
                <mxCell id="key2" value="• Pattern Tree: 从根节点递归展开，匹配完整表达式子树" style="text;html=1;align=left;fontSize=11;" parent="1" vertex="1">
                    <mxGeometry x="60" y="670" width="450" height="25" as="geometry"/>
                </mxCell>
                <mxCell id="key3" value="• 两阶段匹配: egglog擅长扁平匹配，MeggEGraph擅长控制流检索" style="text;html=1;align=left;fontSize=11;fontStyle=1;fontColor=#6c8ebf;" parent="1" vertex="1">
                    <mxGeometry x="60" y="695" width="450" height="25" as="geometry"/>
                </mxCell>
                <mxCell id="key4" value="• component_instr: egglog rewrite自动匹配所有等价形式" style="text;html=1;align=left;fontSize=11;" parent="1" vertex="1">
                    <mxGeometry x="530" y="645" width="450" height="25" as="geometry"/>
                </mxCell>
                <mxCell id="key5" value="• 顺序验证: MeggEGraph的last_matched_index确保Vec中root按序出现" style="text;html=1;align=left;fontSize=11;" parent="1" vertex="1">
                    <mxGeometry x="530" y="670" width="450" height="25" as="geometry"/>
                </mxCell>
                <mxCell id="key6" value="• 性能优化: cf_index + 本地Python实现 = 高效控制流匹配" style="text;html=1;align=left;fontSize=11;fontStyle=1;fontColor=#b85450;" parent="1" vertex="1">
                    <mxGeometry x="530" y="695" width="450" height="25" as="geometry"/>
                </mxCell>
                <mxCell id="note1" value="then块有2个根节点！" style="text;html=1;align=center;fontSize=10;fontStyle=2;fontColor=#b85450;" parent="1" vertex="1">
                    <mxGeometry x="760" y="265" width="130" height="20" as="geometry"/>
                </mxCell>
                <mxCell id="arrow1" style="edgeStyle=none;html=1;strokeColor=#b85450;strokeWidth=2;dashed=1;endArrow=classic;" parent="1" source="note1" edge="1">
                    <mxGeometry relative="1" as="geometry">
                        <mxPoint x="720" y="250" as="targetPoint"/>
                    </mxGeometry>
                </mxCell>
            </root>
        </mxGraphModel>
    </diagram>
</mxfile>