#!/usr/bin/env python3
"""
APS Frontend - CADL to MLIR Compiler Frontend

A command-line tool for parsing CADL (Computer Architecture Description Language)
files and transforming them to MLIR (Multi-Level Intermediate Representation).
"""

import sys
import argparse
from typing import Optional
from cadl_frontend import parse_proc
from cadl_frontend.parser import CADLParseError
from cadl_frontend.mlir_converter import convert_cadl_to_mlir


def parse_cadl(input_file: str, summary: bool = False) -> None:
    """Parse CADL file and display AST"""
    try:
        with open(input_file, 'r') as f:
            source = f.read()

        print(f"Parsing CADL file: {input_file}")
        ast = parse_proc(source, input_file)

        print("Parse successful!")

        if summary:
            # Summary mode - show brief statistics
            print(f"\nAST Summary:")
            print(f"   - Static variables: {len(ast.statics)}")
            print(f"   - Functions: {len(ast.functions)}")
            print(f"   - Flows: {len(ast.flows)}")
            print(f"   - Regfiles: {len(ast.regfiles)}")

            if ast.statics:
                print(f"\nStatic Variables:")
                for name, static in ast.statics.items():
                    print(f"   - {name}: {static.ty}")

            if ast.functions:
                print(f"\nFunctions:")
                for name in ast.functions.keys():
                    print(f"   - {name}()")

            if ast.flows:
                print(f"\nFlows:")
                for name, flow in ast.flows.items():
                    attrs = []
                    if hasattr(flow, 'attrs') and flow.attrs.attrs:
                        for attr_name, attr_expr in flow.attrs.attrs.items():
                            if attr_expr and hasattr(attr_expr, 'literal'):
                                value = attr_expr.literal.lit.value
                                attrs.append(f"{attr_name}={value}")
                            else:
                                attrs.append(attr_name)
                    attr_str = f" [{', '.join(attrs)}]" if attrs else ""
                    print(f"   - {name}(){attr_str}")
        else:
            # Full AST output
            print(f"\nFull AST:")
            print(ast.pretty_print())

    except CADLParseError as e:
        print(f"Parse Error:\n{e}")
        sys.exit(1)
    except FileNotFoundError:
        print(f"Error: File '{input_file}' not found")
        sys.exit(1)
    except Exception as e:
        print(f"Unexpected error: {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)


def convert_to_mlir(input_file: str, output_file: Optional[str] = None, verify: bool = True) -> None:
    """Convert CADL file to MLIR"""
    try:
        with open(input_file, 'r') as f:
            source = f.read()

        print(f"Parsing CADL file: {input_file}")
        ast = parse_proc(source, input_file)
        print("Parse successful!")

        print(f"Converting to MLIR...")
        mlir_module = convert_cadl_to_mlir(ast)
        print("MLIR conversion successful!")

        mlir_text = str(mlir_module)

        if verify:
            print(f"Verifying MLIR...")
            try:
                # Try to parse the generated MLIR to verify it's valid
                import circt.ir as ir
                import circt
                with ir.Context() as ctx:
                    circt.register_dialects(ctx)
                    ir.Module.parse(mlir_text)
                print("MLIR verification successful!")
            except Exception as e:
                print(f"MLIR verification failed: {e}")
                if not output_file:
                    sys.exit(1)

        if output_file:
            # Write to file
            with open(output_file, 'w') as f:
                f.write(mlir_text)
            print(f"MLIR written to: {output_file}")
        else:
            # Print to stdout
            print(f"\nGenerated MLIR:")
            print("=" * 60)
            print(mlir_text)
            print("=" * 60)

    except CADLParseError as e:
        print(f"Parse Error:\n{e}")
        sys.exit(1)
    except FileNotFoundError:
        print(f"Error: File '{input_file}' not found")
        sys.exit(1)
    except Exception as e:
        print(f"Conversion error: {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)


def main():
    """Main CLI entry point"""
    parser = argparse.ArgumentParser(
        prog='aps-frontend',
        description='APS Frontend - CADL to MLIR Compiler Frontend',
        epilog='''
Examples:
  aps-frontend parse examples/simple.cadl           # Parse and show full AST
  aps-frontend parse examples/simple.cadl --summary # Parse and show summary
  aps-frontend mlir examples/simple.cadl            # Convert to MLIR (stdout)
  aps-frontend mlir examples/simple.cadl -o out.mlir # Convert to MLIR file
  aps-frontend mlir examples/simple.cadl --no-verify # Skip MLIR verification
        ''',
        formatter_class=argparse.RawDescriptionHelpFormatter
    )

    subparsers = parser.add_subparsers(dest='command', help='Available commands')

    # Parse subcommand
    parse_parser = subparsers.add_parser(
        'parse',
        help='Parse CADL file and display AST',
        description='Parse a CADL file and display the resulting Abstract Syntax Tree'
    )
    parse_parser.add_argument('input', help='Input CADL file')
    parse_parser.add_argument(
        '--summary', '-s',
        action='store_true',
        help='Show summary instead of full AST'
    )

    # MLIR subcommand
    mlir_parser = subparsers.add_parser(
        'mlir',
        help='Convert CADL file to MLIR',
        description='Convert a CADL file to MLIR intermediate representation'
    )
    mlir_parser.add_argument('input', help='Input CADL file')
    mlir_parser.add_argument(
        '-o', '--output',
        help='Output MLIR file (default: print to stdout)'
    )
    mlir_parser.add_argument(
        '--no-verify',
        action='store_true',
        help='Skip MLIR verification step'
    )

    # Version info
    parser.add_argument(
        '--version', '-v',
        action='version',
        version='aps-frontend 1.0.0'
    )

    args = parser.parse_args()

    if not args.command:
        parser.print_help()
        sys.exit(1)

    if args.command == 'parse':
        parse_cadl(args.input, args.summary)
    elif args.command == 'mlir':
        convert_to_mlir(args.input, args.output, not args.no_verify)


if __name__ == '__main__':
    main()